<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>iframe</title>
<style>
:root { --bg-color: #f0f0f4; --toolbar-bg: #f9f9fb; --text-color: #000; --border-color: #d0d0d7; --accent: #0060df; }
body.dark-mode { --bg-color: #1c1b22; --toolbar-bg: #2b2a33; --text-color: #fbfbfe; --border-color: #52525e; --accent: #00ddff; }
body { margin: 0; font-family: system-ui, sans-serif; background: var(--bg-color); color: var(--text-color); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

#progress-container { position: absolute; top: 0; left: 0; width: 100%; height: 2px; z-index: 1000; pointer-events: none; }
#progress-bar { width: 0%; height: 100%; background: var(--accent); transition: width 0.3s ease; }

#tabs-bar { display: flex; background: var(--bg-color); padding: 5px 5px 0 5px; gap: 4px; border-bottom: 1px solid var(--border-color); overflow-x: auto; min-height: 35px; scrollbar-width: none; }
#tabs-bar::-webkit-scrollbar { display: none; }
.tab { padding: 6px 12px; background: rgba(0,0,0,0.05); border-radius: 8px 8px 0 0; cursor: pointer; min-width: 140px; max-width: 200px; display: flex; align-items: center; font-size: 11px; border: 1px solid var(--border-color); border-bottom: none; white-space: nowrap; transition: 0.2s; }
.tab.active { background: var(--toolbar-bg); font-weight: bold; border-top: 2px solid var(--accent); }
.tab img { width: 14px; height: 14px; margin-right: 6px; border-radius: 2px; }
.tab-title { flex: 1; overflow: hidden; text-overflow: ellipsis; }
.close-btn { margin-left: 8px; opacity: 0.3; font-size: 14px; }
.close-btn:hover { color: red; opacity: 1; }

#chrome { background: var(--toolbar-bg); border-bottom: 1px solid var(--border-color); padding: 8px; display: flex; gap: 8px; align-items: center; z-index: 10; }
#url { flex: 1; padding: 8px 15px; border-radius: 20px; border: 1px solid var(--border-color); background: var(--bg-color); color: var(--text-color); font-size: 13px; }

#bookmark-bar { background: var(--toolbar-bg); padding: 4px 10px; display: flex; gap: 10px; border-bottom: 1px solid var(--border-color); font-size: 11px; overflow-x: auto; min-height: 20px; }
.bm-item { display: flex; align-items: center; gap: 4px; cursor: pointer; padding: 4px 8px; border-radius: 4px; white-space: nowrap; max-width: 150px; }
.bm-item:hover { background: rgba(0,0,0,0.05); }
.bm-item img { width: 12px; height: 12px; }

.star-btn { font-size: 20px; cursor: pointer; color: #ccc; }
.star-btn.active { color: #f1c40f; }

#main-container { display: flex; flex: 1; overflow: hidden; position: relative; }
#view { flex: 1; background: white; position: relative; }
.page-element { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; display: none; background: white; }
.page-element.active { display: block; }

.settings-page { padding: 40px 20px; overflow-y: auto; box-sizing: border-box; background: var(--bg-color) !important; }
.card { background: var(--toolbar-bg); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color); max-width: 600px; margin: 0 auto 20px; color: var(--text-color); }
.preset-group { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; }
.proxy-item { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid var(--border-color); }
.status-connected { color: #28a745; font-weight: bold; font-size: 13px; margin-right: 8px; }

button { padding: 6px 12px; cursor: pointer; border-radius: 4px; border: 1px solid var(--border-color); background: rgba(0,0,0,0.05); color: inherit; }
button:disabled { opacity: 0.3; cursor: default; }
select, input[type="text"] { padding: 8px; border-radius: 4px; border: 1px solid var(--border-color); background: var(--bg-color); color: var(--text-color); }
</style>
</head>
<body>

<div id="progress-container"><div id="progress-bar"></div></div>

<div id="tabs-bar"></div>
<div id="chrome">
    <button id="btn-back" onclick="navBack()">‚óÄ</button>
    <button id="btn-forward" onclick="navForward()">‚ñ∂</button>
    <button onclick="navReload()">‚ü≥</button>
    <button onclick="goHome()">‚óªÔ∏è</button>
    <span id="star-btn" class="star-btn" onclick="toggleBookmark()">‚òÖ</span>
    <input id="url" placeholder="URL„ÇíÂÖ•Âäõ„Åó„Å¶Enter">
    <button onclick="go()">Go</button>
    <button onclick="openSettings()">‚öôÔ∏è</button>
</div>
<div id="bookmark-bar"></div>

<div id="main-container">
    <div id="view"></div>
</div>

<script>
let tabs = [];
let activeTabId = null;
let settings = {
    homeUrl: "https://google.com/?igu=1",
    darkMode: false,
    bookmarks: [],
    viewMode: "iframe",
    activeProxyId: null
};

const PROXIES = {
    1: { name: "Proxy1", url: "https://55gms.com/embed.html#", info: "US - NY" },
    2: { name: "Proxy2", url: "https://55gms.me/embed.html#", info: "US - NY" },
    3: { name: "Proxy3", url: "https://55gms.app/embed.html#", info: "US - NY" },
    4: { name: "Proxy4", url: "https://algebra.learnnexus.xyz/embed.html#", info: "US - NY" },
    5: { name: "Proxy5", url: "https://biology.learnnexus.xyz/embed.html#", info: "US - NY" }
};

const PRESETS = [
    { name: "Google", url: "https://google.com/?igu=1" },
    { name: "OffiDocs", url: "https://search.offidocs.com" },
    { name: "Excite", url: "https://excite.co.jp" }
];

const SANDBOX_SETTINGS = "allow-forms allow-modals allow-orientation-lock allow-pointer-lock allow-presentation allow-same-origin allow-scripts allow-storage-access-by-user-activation";

function setProgress(percent) {
    const bar = document.getElementById('progress-bar');
    bar.style.width = percent + "%";
    if (percent >= 100) setTimeout(() => { bar.style.width = "0%"; }, 400);
}

function getIconUrl(url) {
    if (url === "settings://") return "https://www.gstatic.com/images/branding/product/1x/settings_32dp.png";
    try {
        const domain = new URL(url).hostname;
        return `https://www.google.com/s2/favicons?domain=${domain}&sz=32`;
    } catch(e) { return "https://www.google.com/s2/favicons?domain=example.com"; }
}

function init() {
    const saved = localStorage.getItem('browser-settings');
    if (saved) settings = JSON.parse(saved);
    if (settings.darkMode) document.body.classList.add('dark-mode');
    
    const savedTabs = localStorage.getItem('browser-sessions');
    if (savedTabs) {
        const parsed = JSON.parse(savedTabs);
        parsed.forEach(t => createTabObject(t.url, t.id, t.title, t.history, t.historyIndex));
        switchTab(parseInt(localStorage.getItem('browser-last-active')) || tabs[0].id);
    } else { createNewTab(settings.homeUrl); }
    renderBookmarkBar();
}

function getEffectiveUrl(url) {
    return (url === "settings://" || !settings.activeProxyId) ? url : PROXIES[settings.activeProxyId].url + url;
}

function createTabObject(url, id = Date.now(), title = "Ë™≠„ÅøËæº„Åø‰∏≠...", history = null, hIndex = 0) {
    const tab = { id, url, title, history: history || [url], historyIndex: hIndex, element: null };
    updateTabElement(tab);
    tabs.push(tab);
    return tab;
}

function updateTabElement(tab) {
    if (tab.element) tab.element.remove();
    const viewArea = document.getElementById('view');
    let el;

    if (tab.url === "settings://") {
        el = document.createElement('div');
        el.className = "page-element settings-page";
        renderSettingsInto(el);
    } else {
        const finalUrl = getEffectiveUrl(tab.url);
        if (settings.viewMode === "object") {
            el = document.createElement('object'); el.data = finalUrl; el.type = "text/html";
        } else if (settings.viewMode === "embed") {
            el = document.createElement('embed'); el.src = finalUrl; el.type = "text/html";
        } else {
            el = document.createElement('iframe'); el.src = finalUrl; el.setAttribute("sandbox", SANDBOX_SETTINGS);
        }
        el.className = "page-element";
        setProgress(30);
        el.onload = () => {
            setProgress(100);
            try {
                if (el.contentDocument && el.contentDocument.title) tab.title = el.contentDocument.title;
                else tab.title = new URL(tab.url).hostname;
            } catch(e) { tab.title = tab.url.replace(/https?:\/\//,'').split('/')[0]; }
            renderTabsUI(); updateStarUI();
        };
    }
    el.id = `page-${tab.id}`;
    if (tab.id === activeTabId) el.classList.add('active');
    viewArea.appendChild(el);
    tab.element = el;
}

function switchTab(id) {
    activeTabId = id;
    tabs.forEach(t => {
        const active = t.id === id;
        t.element.classList.toggle('active', active);
        if (active) {
            document.getElementById('url').value = t.url;
            if (t.url === "settings://") renderSettingsInto(t.element);
        }
    });
    updateNavButtons(); updateStarUI(); renderTabsUI(); saveState();
}

function renderTabsUI() {
    const bar = document.getElementById('tabs-bar');
    bar.innerHTML = '';
    tabs.forEach(t => {
        const div = document.createElement('div');
        div.className = `tab ${t.id === activeTabId ? 'active' : ''}`;
        div.innerHTML = `<img src="${getIconUrl(t.url)}"><span class="tab-title">${t.title}</span><span class="close-btn" onclick="closeTab(${t.id}, event)">√ó</span>`;
        div.onclick = () => switchTab(t.id);
        bar.appendChild(div);
    });
    const add = document.createElement('button'); add.textContent = "+"; add.style="height:28px; margin-top:5px;"; add.onclick = () => createNewTab(); bar.appendChild(add);
}

function renderBookmarkBar() {
    const bar = document.getElementById('bookmark-bar');
    bar.innerHTML = '';
    settings.bookmarks.forEach(bm => {
        const div = document.createElement('div');
        div.className = 'bm-item';
        div.innerHTML = `<img src="${getIconUrl(bm.url)}"><span>${bm.title}</span>`;
        div.onclick = () => { document.getElementById('url').value = bm.url; go(); };
        bar.appendChild(div);
    });
}

function toggleBookmark() {
    const tab = tabs.find(t => t.id === activeTabId);
    if (tab.url === "settings://") return;
    const idx = settings.bookmarks.findIndex(b => b.url === tab.url);
    if (idx > -1) settings.bookmarks.splice(idx, 1);
    else settings.bookmarks.push({ title: tab.title, url: tab.url });
    updateStarUI(); renderBookmarkBar(); saveState();
}

function go() {
    let url = document.getElementById('url').value;
    if (url !== "settings://" && !url.startsWith('http')) url = "https://" + url;
    const tab = tabs.find(t => t.id === activeTabId);
    if (tab.url !== url) {
        tab.history = tab.history.slice(0, tab.historyIndex + 1);
        tab.history.push(url); tab.historyIndex++; tab.url = url;
        updateTabElement(tab); switchTab(tab.id);
    }
}

function navBack() {
    const t = tabs.find(x => x.id === activeTabId);
    if (t && t.historyIndex > 0) { t.historyIndex--; t.url = t.history[t.historyIndex]; updateTabElement(t); switchTab(t.id); }
}

function navForward() {
    const t = tabs.find(x => x.id === activeTabId);
    if (t && t.historyIndex < t.history.length - 1) { t.historyIndex++; t.url = t.history[t.historyIndex]; updateTabElement(t); switchTab(t.id); }
}

function updateNavButtons() {
    const t = tabs.find(x => x.id === activeTabId);
    if (!t) return;
    document.getElementById('btn-back').disabled = (t.historyIndex <= 0);
    document.getElementById('btn-forward').disabled = (t.historyIndex >= t.history.length - 1);
}

function updateStarUI() {
    const t = tabs.find(x => x.id === activeTabId);
    const isB = settings.bookmarks.some(b => b.url === (t ? t.url : ""));
    document.getElementById('star-btn').classList.toggle('active', isB);
}

function createNewTab(url = settings.homeUrl) { switchTab(createTabObject(url).id); }

function closeTab(id, e) {
    e.stopPropagation(); if (tabs.length === 1) return;
    const idx = tabs.findIndex(t => t.id === id); tabs[idx].element.remove(); tabs.splice(idx, 1);
    switchTab(tabs[Math.max(0, idx-1)].id);
}

function saveState() {
    localStorage.setItem('browser-settings', JSON.stringify(settings));
    localStorage.setItem('browser-sessions', JSON.stringify(tabs.map(t => ({id: t.id, url: t.url, title: t.title, history: t.history, historyIndex: t.historyIndex}))));
    localStorage.setItem('browser-last-active', activeTabId);
}

function navReload() { const t = tabs.find(x => x.id === activeTabId); if(t) updateTabElement(t); }
function openSettings() { document.getElementById('url').value = "settings://"; go(); }
function goHome() { document.getElementById('url').value = settings.homeUrl; go(); }

function renderSettingsInto(container) {
    let proxyHtml = "";
    for (const id in PROXIES) {
        const p = PROXIES[id]; const isC = settings.activeProxyId == id;
        proxyHtml += `<div class="proxy-item"><div><strong>${p.name}</strong><br><small>${p.info}</small></div><div>${isC?'<span class="status-connected">Êé•Á∂ö‰∏≠</span>':''}<button onclick="toggleProxy(${id})">${isC?'ÂàáÊñ≠':'Êé•Á∂ö'}</button></div></div>`;
    }

    container.innerHTML = `
        <div class="card"><h3>‚òÖ „Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØÁÆ°ÁêÜ</h3>
            ${settings.bookmarks.length === 0 ? '<p style="opacity:0.5">„Å™„Åó</p>' : 
              settings.bookmarks.map((b,i)=>`<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                <span><img src="${getIconUrl(b.url)}" style="width:12px; margin-right:5px;">${b.title}</span>
                <button onclick="settings.bookmarks.splice(${i},1);saveState();renderSettingsInto(document.querySelector('.settings-page'));renderBookmarkBar();">ÂâäÈô§</button>
              </div>`).join('')}
        </div>

        <div class="card"><h3>‚óªÔ∏è „Éõ„Éº„É†Ë®≠ÂÆö</h3>
            <div style="display:flex; gap:8px; margin-bottom:10px;"><input type="text" id="set-home" value="${settings.homeUrl}" style="flex:1;"><button onclick="settings.homeUrl=document.getElementById('set-home').value;saveState();alert('‰øùÂ≠ò„Åó„Åæ„Åó„Åü')">‰øùÂ≠ò</button></div>
            <div class="preset-group" id="plist"></div>
        </div>

        <div class="card"><h3>üåì Ë°®Á§∫Ë®≠ÂÆö</h3>
            <button onclick="settings.darkMode=!settings.darkMode; document.body.classList.toggle('dark-mode'); saveState(); renderSettingsInto(document.querySelector('.settings-page'));">„ÉÄ„Éº„ÇØ„É¢„Éº„ÉâÂàáÊõø</button>
            <select onchange="settings.viewMode=this.value; saveState();" style="margin-left:10px;">
                <option value="iframe" ${settings.viewMode==='iframe'?'selected':''}>iframe</option>
                <option value="object" ${settings.viewMode==='object'?'selected':''}>object</option>
                <option value="embed" ${settings.viewMode==='embed'?'selected':''}>embed</option>
            </select>
        </div>

        <div class="card"><h3>üåê „Éó„É≠„Ç≠„Ç∑Ë®≠ÂÆö</h3>${proxyHtml}</div>
    `;

    PRESETS.forEach(p => {
        const b = document.createElement('button'); b.textContent = p.name;
        b.onclick = () => { document.getElementById('set-home').value = p.url; settings.homeUrl = p.url; saveState(); };
        container.querySelector('#plist').appendChild(b);
    });
}

window.toggleProxy = (id) => {
    settings.activeProxyId = (settings.activeProxyId == id) ? null : id;
    saveState();
    const t = tabs.find(x => x.id === activeTabId);
    if (t && t.url !== "settings://") updateTabElement(t);
    renderSettingsInto(document.querySelector('.settings-page'));
};

document.getElementById("url").addEventListener("keydown", e => { if (e.key === "Enter") go(); });
init();
</script>
</body>
</html>
