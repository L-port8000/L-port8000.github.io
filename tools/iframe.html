<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>iframe</title>
<style>
:root { --bg-color: #f0f0f4; --toolbar-bg: #f9f9fb; --text-color: #000; --border-color: #d0d0d7; --accent: #0060df; }
body.dark-mode { --bg-color: #1c1b22; --toolbar-bg: #2b2a33; --text-color: #fbfbfe; --border-color: #52525e; --accent: #00ddff; }
body { margin: 0; font-family: system-ui, sans-serif; background: var(--bg-color); color: var(--text-color); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

#progress-container { position: absolute; top: 0; left: 0; width: 100%; height: 2px; z-index: 1000; pointer-events: none; }
#progress-bar { width: 0%; height: 100%; background: var(--accent); transition: width 0.3s ease; }

#tabs-bar { display: flex; background: var(--bg-color); padding: 5px 5px 0 5px; gap: 4px; border-bottom: 1px solid var(--border-color); overflow-x: auto; min-height: 35px; }
#tabs-bar.hidden { display: none; }
.tab { padding: 6px 12px; background: rgba(0,0,0,0.05); border-radius: 8px 8px 0 0; cursor: pointer; min-width: 120px; max-width: 180px; display: flex; justify-content: space-between; align-items: center; font-size: 11px; border: 1px solid var(--border-color); border-bottom: none; white-space: nowrap; }
.tab.active { background: var(--toolbar-bg); font-weight: bold; border-top: 2px solid var(--accent); }
.close-btn { margin-left: 8px; opacity: 0.5; }
.close-btn:hover { color: red; opacity: 1; }

#chrome { background: var(--toolbar-bg); border-bottom: 1px solid var(--border-color); padding: 8px; display: flex; gap: 8px; align-items: center; z-index: 10; position: relative; }
#url { flex: 1; padding: 8px 15px; border-radius: 20px; border: 1px solid var(--border-color); background: var(--bg-color); color: var(--text-color); }

.star-btn { font-size: 20px; cursor: pointer; color: #ccc; user-select: none; }
.star-btn.active { color: #f1c40f; }

#main-container { display: flex; flex: 1; overflow: hidden; position: relative; }
#side-tabs { width: 180px; background: var(--toolbar-bg); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; padding: 8px; gap: 4px; overflow-y: auto; }
#side-tabs.hidden { display: none; }

#view { flex: 1; background: white; position: relative; }
.page-element { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; display: none; }
.page-element.active { display: block; }

.settings-page { padding: 40px 20px; overflow-y: auto; box-sizing: border-box; }
.card { background: var(--toolbar-bg); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color); max-width: 600px; margin: 0 auto 20px; color: var(--text-color); }
.preset-group { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; }
.proxy-item { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid var(--border-color); }
.status-connected { color: #28a745; font-weight: bold; font-size: 13px; margin-right: 8px; }

button { padding: 6px 12px; cursor: pointer; border-radius: 4px; border: 1px solid var(--border-color); background: rgba(0,0,0,0.1); color: inherit; }
button:disabled { opacity: 0.3; cursor: default; }
</style>
</head>
<body>

<div id="progress-container"><div id="progress-bar"></div></div>

<div id="tabs-bar"></div>
<div id="chrome">
    <button id="btn-back" onclick="navBack()">‚óÄ</button>
    <button id="btn-forward" onclick="navForward()">‚ñ∂</button>
    <button onclick="navReload()">‚ü≥</button>
    <button onclick="goHome()">‚óªÔ∏è</button>
    <span id="star-btn" class="star-btn" onclick="toggleBookmark()">‚òÖ</span>
    <input id="url" placeholder="URL„Åæ„Åü„ÅØÊ§úÁ¥¢Ë™ûÂè•„ÇíÂÖ•Âäõ">
    <button onclick="go()">Go</button>
    <button onclick="openSettings()">‚öôÔ∏è</button>
</div>
<div id="main-container">
    <div id="side-tabs"></div>
    <div id="view"></div>
</div>

<script>
let tabs = [];
let activeTabId = null;
let settings = {
    homeUrl: "https://google.com/?igu=1",
    darkMode: false,
    useVerticalTabs: false,
    activeProxyId: null,
    bookmarks: []
};

const PROXIES = {
    1: { name: "Proxy1", url: "https://55gms.com/embed.html#", info: "US - NY" },
    2: { name: "Proxy2", url: "https://55gms.me/embed.html#", info: "US - NY" },
    3: { name: "Proxy3", url: "https://55gms.app/embed.html#", info: "US - NY" },
    4: { name: "Proxy4", url: "https://algebra.learnnexus.xyz/embed.html#", info: "US - NY" },
    5: { name: "Proxy5", url: "https://biology.learnnexus.xyz/embed.html#", info: "US - NY" }
};

const PRESETS = [
    { name: "Google", url: "https://google.com/?igu=1" },
    { name: "OffiDocs", url: "https://search.offidocs.com" },
    { name: "Excite", url: "https://excite.co.jp" }
];

const SANDBOX_SETTINGS = "allow-forms allow-modals allow-orientation-lock allow-pointer-lock allow-presentation allow-same-origin allow-scripts allow-storage-access-by-user-activation";

function setProgress(percent) {
    const bar = document.getElementById('progress-bar');
    bar.style.width = percent + "%";
    if (percent >= 100) setTimeout(() => { bar.style.width = "0%"; }, 400);
}

function init() {
    const saved = localStorage.getItem('browser-settings');
    if (saved) settings = JSON.parse(saved);
    if (!settings.bookmarks) settings.bookmarks = [];
    if (settings.darkMode) document.body.classList.add('dark-mode');
    applyTabMode();
    
    const savedTabs = localStorage.getItem('browser-sessions');
    if (savedTabs) {
        const parsed = JSON.parse(savedTabs);
        parsed.forEach(t => createTabObject(t.url, t.id, t.title, t.history, t.historyIndex));
        switchTab(parseInt(localStorage.getItem('browser-last-active')) || tabs[0].id);
    } else { createNewTab(settings.homeUrl); }
}

function createTabObject(url, id = Date.now(), title = "Loading...", history = null, hIndex = 0) {
    const view = document.getElementById('view');
    const tab = { 
        id, 
        url, 
        title, 
        history: history || [url], 
        historyIndex: hIndex,
        element: null 
    };
    
    updateTabElement(tab);
    tabs.push(tab);
    return tab;
}

function updateTabElement(tab) {
    if (tab.element) tab.element.remove();
    const el = (tab.url === "settings://") ? document.createElement('div') : document.createElement('iframe');
    el.id = `page-${tab.id}`;
    el.className = "page-element" + (tab.id === activeTabId ? " active" : "");
    
    if (tab.url === "settings://") {
        renderSettingsInto(el);
    } else {
        el.setAttribute("sandbox", SANDBOX_SETTINGS);
        el.src = getEffectiveUrl(tab.url);
        setProgress(30);
        el.onload = () => {
            setProgress(100);
            tab.title = tab.url.replace(/https?:\/\//, '').split('/')[0] || tab.url;
            renderTabsUI();
            updateStarUI();
        };
    }
    document.getElementById('view').appendChild(el);
    tab.element = el;
}

function switchTab(id) {
    activeTabId = id;
    tabs.forEach(t => {
        const active = t.id === id;
        t.element.classList.toggle('active', active);
        if (active) {
            document.getElementById('url').value = t.url;
            if (t.url === "settings://") renderSettingsInto(t.element);
        }
    });
    updateNavButtons();
    updateStarUI();
    renderTabsUI();
    saveState();
}

function go() {
    let url = document.getElementById('url').value;
    if (url !== "settings://" && !url.startsWith('http')) url = "https://" + url;
    const tab = tabs.find(t => t.id === activeTabId);
    
    if (tab.url !== url) {
        tab.history = tab.history.slice(0, tab.historyIndex + 1);
        tab.history.push(url);
        tab.historyIndex++;
        tab.url = url;
        updateTabElement(tab);
        updateNavButtons();
        saveState();
    }
}

function navBack() {
    const tab = tabs.find(t => t.id === activeTabId);
    if (tab && tab.historyIndex > 0) {
        tab.historyIndex--;
        tab.url = tab.history[tab.historyIndex];
        updateTabElement(tab);
        switchTab(tab.id);
    }
}

function navForward() {
    const tab = tabs.find(t => t.id === activeTabId);
    if (tab && tab.historyIndex < tab.history.length - 1) {
        tab.historyIndex++;
        tab.url = tab.history[tab.historyIndex];
        updateTabElement(tab);
        switchTab(tab.id);
    }
}

function updateNavButtons() {
    const tab = tabs.find(t => t.id === activeTabId);
    if (!tab) return;
    document.getElementById('btn-back').disabled = (tab.historyIndex <= 0);
    document.getElementById('btn-forward').disabled = (tab.historyIndex >= tab.history.length - 1);
}

function getEffectiveUrl(url) { return (url === "settings://" || !settings.activeProxyId) ? url : PROXIES[settings.activeProxyId].url + url; }
function saveState() {
    localStorage.setItem('browser-settings', JSON.stringify(settings));
    localStorage.setItem('browser-sessions', JSON.stringify(tabs.map(t => ({id: t.id, url: t.url, title: t.title, history: t.history, historyIndex: t.historyIndex}))));
    localStorage.setItem('browser-last-active', activeTabId);
}
function createNewTab(url = settings.homeUrl) { switchTab(createTabObject(url).id); }
function closeTab(id, e) { e.stopPropagation(); if (tabs.length === 1) return; const idx = tabs.findIndex(t => t.id === id); tabs[idx].element.remove(); tabs.splice(idx, 1); switchTab(tabs[Math.max(0, idx-1)].id); }
function navReload() { const t = tabs.find(x => x.id === activeTabId); if(t) updateTabElement(t); }
function openSettings() { document.getElementById('url').value = "settings://"; go(); }
function goHome() { document.getElementById('url').value = settings.homeUrl; go(); }
function toggleBookmark() {
    const tab = tabs.find(t => t.id === activeTabId);
    if (tab.url === "settings://") return;
    const idx = settings.bookmarks.findIndex(b => b.url === tab.url);
    if (idx > -1) settings.bookmarks.splice(idx, 1);
    else settings.bookmarks.push({ title: tab.title, url: tab.url });
    updateStarUI(); saveState();
}
function updateStarUI() {
    const tab = tabs.find(t => t.id === activeTabId);
    const isB = settings.bookmarks.some(b => b.url === (tab ? tab.url : ""));
    document.getElementById('star-btn').classList.toggle('active', isB);
}
function applyTabMode() {
    document.getElementById('side-tabs').classList.toggle('hidden', !settings.useVerticalTabs);
    document.getElementById('tabs-bar').classList.toggle('hidden', settings.useVerticalTabs);
}
function renderTabsUI() {
    const hBar = document.getElementById('tabs-bar');
    const vBar = document.getElementById('side-tabs');
    const createEl = (t) => {
        const div = document.createElement('div');
        div.className = `tab ${t.id === activeTabId ? 'active' : ''}`;
        div.innerHTML = `<span style="overflow:hidden;text-overflow:ellipsis;">${t.title}</span><span class="close-btn" onclick="closeTab(${t.id}, event)">√ó</span>`;
        div.onclick = () => switchTab(t.id);
        return div;
    };
    hBar.innerHTML = ''; vBar.innerHTML = '<small style="opacity:0.5;margin-bottom:5px;">VERTICAL TABS</small>';
    if (!settings.useVerticalTabs) { tabs.forEach(t => hBar.appendChild(createEl(t))); const add = document.createElement('button'); add.textContent = "+"; add.onclick = () => createNewTab(); hBar.appendChild(add); }
    else { tabs.forEach(t => vBar.appendChild(createEl(t))); const addV = document.createElement('button'); addV.textContent = "+ Êñ∞Ë¶è„Çø„Éñ"; addV.onclick = () => createNewTab(); vBar.appendChild(addV); }
}

function renderSettingsInto(container) {
    container.className = "page-element settings-page active";
    let bks = settings.bookmarks.length ? "" : "<p style='opacity:0.6'>„Å™„Åó</p>";
    settings.bookmarks.forEach((b, i) => {
        bks += `<div class="bookmark-item"><a href="#" style="color:var(--accent);text-decoration:none;flex:1" onclick="document.getElementById('url').value='${b.url}';go();">${b.title}</a><button onclick="settings.bookmarks.splice(${i},1);saveState();renderSettingsInto(document.querySelector('.settings-page'))">ÂâäÈô§</button></div>`;
    });
    let proxies = "";
    for (const id in PROXIES) {
        const p = PROXIES[id]; const isC = settings.activeProxyId == id;
        proxies += `<div class="proxy-item"><div><strong>${p.name}</strong><br><small>${p.info}</small></div><div>${isC?'<span class="status-connected">Êé•Á∂ö‰∏≠</span>':''}<button onclick="toggleProxy(${id})">${isC?'ÂàáÊñ≠':'Êé•Á∂ö'}</button></div></div>`;
    }
    container.innerHTML = `
        <div class="card"><h3>‚òÖ „Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ</h3>${bks}</div>
        <div class="card"><h3>‚óªÔ∏è „Éõ„Éº„É†Ë®≠ÂÆö</h3><div style="display:flex;gap:8px"><input id="set-home" value="${settings.homeUrl}" style="flex:1;padding:8px;"><button onclick="settings.homeUrl=document.getElementById('set-home').value;saveState();alert('‰øùÂ≠òÊ∏à')">‰øùÂ≠ò</button></div><div class="preset-group" id="plist"></div></div>
        <div class="card"><h3>„Éá„Ç∂„Ç§„É≥</h3><button onclick="toggleSet('darkMode')">„ÉÄ„Éº„ÇØ„É¢„Éº„Éâ: ${settings.darkMode?'ON':'OFF'}</button> <button onclick="toggleSet('useVerticalTabs')">Á∏¶„Çø„Éñ: ${settings.useVerticalTabs?'ON':'OFF'}</button></div>
        <div class="card"><h3>üåê PROXY (Popup Blocked)</h3>${proxies}</div>
    `;
    PRESETS.forEach(p => { const b = document.createElement('button'); b.textContent = p.name; b.onclick = () => { document.getElementById('set-home').value = p.url; settings.homeUrl = p.url; saveState(); }; container.querySelector('#plist').appendChild(b); });
}

window.toggleProxy = (id) => { settings.activeProxyId = (settings.activeProxyId == id) ? null : id; saveState(); renderSettingsInto(document.querySelector('.settings-page')); };
window.toggleSet = (key) => { settings[key] = !settings[key]; if(key==='darkMode') document.body.classList.toggle('dark-mode'); applyTabMode(); saveState(); renderSettingsInto(document.querySelector('.settings-page')); renderTabsUI(); };

document.getElementById("url").addEventListener("keydown", e => { if (e.key === "Enter") go(); });
init();
</script>
</body>
</html>
